{% extends 'base.html' %}
{% load static %}

{% block title %}MaStR Lead-Generierung{% endblock %}

{% block extra_css %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
<style>
    .anlagen-listen-panel {
        background: #f8f9fa;
        border-left: 3px solid #007bff;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 5px;
    }
    
    .liste-item {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 10px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .liste-item:hover {
        border-color: #007bff;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .liste-item.selected {
        border-color: #007bff;
        background-color: #e3f2fd;
    }
    
    .save-button {
        background: #28a745;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 3px;
        font-size: 12px;
        cursor: pointer;
        transition: background 0.2s;
    }
    
    .save-button:hover {
        background: #218838;
    }
    
    .save-button:disabled {
        background: #6c757d;
        cursor: not-allowed;
    }
    
    .table-responsive {
        max-height: 600px;
        overflow-y: auto;
    }
    
    .table th {
        position: sticky;
        top: 0;
        background: white;
        z-index: 10;
    }
    
    /* Sortierbare Tabellen-Header */
    .table th.sortable {
        cursor: pointer;
        user-select: none;
    }
    
    .table th.sortable:hover {
        background-color: #f8f9fa;
    }
    
    .table th.sort-asc::after {
        content: ' ▲';
        color: #007bff;
    }
    
    .table th.sort-desc::after {
        content: ' ▼';
        color: #007bff;
    }
    
    /* Verbesserte Hover-Effekte */
    .table tbody tr:hover {
        background-color: #f8f9fa;
        transform: scale(1.001);
        transition: all 0.2s ease;
    }
    
    /* Checkbox-Styling */
    .anlage-checkbox:checked {
        background-color: #007bff;
        border-color: #007bff;
    }
    
    /* Button-Animationen */
    .btn {
        transition: all 0.2s ease;
    }
    
    .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    /* Loading-Animation */
    .loading {
        opacity: 0.6;
        pointer-events: none;
    }
    
    /* Erfolgsmeldung Animation */
    .alert-success {
        animation: slideInDown 0.5s ease;
    }
    
    @keyframes slideInDown {
        from {
            transform: translateY(-20px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
    
    /* Kartenansicht Styling */
    .view-toggle {
        margin-bottom: 20px;
    }
    
    .card-view {
        display: none;
    }
    
    .card-view.active {
        display: block;
    }
    
    .table-view {
        display: none;
    }
    
    .table-view.active {
        display: block;
    }
    
    .anlage-card {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .anlage-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        border-color: #007bff;
    }
    
    .anlage-card.selected {
        border-color: #007bff;
        background-color: #f8f9ff;
    }
    
    .anlage-header {
        display: flex;
        justify-content: between;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .anlage-title {
        font-size: 1.2em;
        font-weight: bold;
        color: #333;
        margin: 0;
    }
    
    .anlage-status {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: bold;
    }
    
    .status-active {
        background-color: #d4edda;
        color: #155724;
    }
    
    .status-inactive {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .anlage-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 15px;
    }
    
    .detail-item {
        display: flex;
        align-items: center;
    }
    
    .detail-icon {
        width: 20px;
        margin-right: 8px;
        color: #007bff;
    }
    
    .detail-label {
        font-weight: bold;
        color: #666;
        margin-right: 5px;
    }
    
    .detail-value {
        color: #333;
    }
    
    .anlage-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }
    
    .btn-save-anlage {
        background: #28a745;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 5px;
        font-size: 0.9em;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .btn-save-anlage:hover {
        background: #218838;
        transform: translateY(-1px);
    }
    
    .btn-save-anlage:disabled {
        background: #6c757d;
        cursor: not-allowed;
    }
    
    .btn-view-details {
        background: #007bff;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 5px;
        font-size: 0.9em;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .btn-view-details:hover {
        background: #0056b3;
        transform: translateY(-1px);
    }
    
    /* Einfache Karte Styling */
    #anlagen-map {
        height: 80vh;
        width: 100%;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        position: relative;
        overflow: hidden;
    }
    
    .map-container {
        position: relative;
        width: 100%;
        height: 100%;
    }
    
    .map-marker {
        position: absolute;
        width: 20px;
        height: 20px;
        background: #007bff;
        border: 3px solid #ffffff;
        border-radius: 50%;
        cursor: pointer;
        transform: translate(-50%, -50%);
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    
    .map-marker:hover {
        background: #0056b3;
        transform: translate(-50%, -50%) scale(1.2);
        box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }
    
    .map-popup {
        position: absolute;
        background: white;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border: 1px solid #dee2e6;
        max-width: 300px;
        z-index: 1000;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        display: none;
    }
    
    .map-popup::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 20px;
        border: 8px solid transparent;
        border-top-color: white;
    }
    
    .map-popup-close {
        position: absolute;
        top: 5px;
        right: 10px;
        background: none;
        border: none;
        font-size: 18px;
        color: #666;
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="h3 mb-0">
                    <i class="fas fa-search text-primary"></i>
                    MaStR Lead-Generierung
                </h1>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-primary active" id="btn-table-view">
                        <i class="fas fa-table"></i> Tabelle
                    </button>
                    <button type="button" class="btn btn-outline-primary" id="btn-card-view">
                        <i class="fas fa-map"></i> Karten
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Suchformular -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-filter"></i>
                        Suchkriterien
                    </h5>
                </div>
                <div class="card-body">
                    <form method="get" id="searchForm">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="energietraeger" class="form-label">Energieträger</label>
                                <select name="energietraeger" id="energietraeger" class="form-select">
                                    <option value="">Alle Energieträger</option>
                                    <option value="Solar" {% if request.GET.energietraeger == 'Solar' %}selected{% endif %}>Solar</option>
                                    <option value="Wind" {% if request.GET.energietraeger == 'Wind' %}selected{% endif %}>Wind</option>
                                    <option value="Biomasse" {% if request.GET.energietraeger == 'Biomasse' %}selected{% endif %}>Biomasse</option>
                                    <option value="Wasser" {% if request.GET.energietraeger == 'Wasser' %}selected{% endif %}>Wasser</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="bundesland" class="form-label">Bundesland</label>
                                <select name="bundesland" id="bundesland" class="form-select">
                                    <option value="">Alle Bundesländer</option>
                                    <option value="Bayern" {% if request.GET.bundesland == 'Bayern' %}selected{% endif %}>Bayern</option>
                                    <option value="Niedersachsen" {% if request.GET.bundesland == 'Niedersachsen' %}selected{% endif %}>Niedersachsen</option>
                                    <option value="Brandenburg" {% if request.GET.bundesland == 'Brandenburg' %}selected{% endif %}>Brandenburg</option>
                                    <option value="Sachsen-Anhalt" {% if request.GET.bundesland == 'Sachsen-Anhalt' %}selected{% endif %}>Sachsen-Anhalt</option>
                                    <option value="Nordrhein-Westfalen" {% if request.GET.bundesland == 'Nordrhein-Westfalen' %}selected{% endif %}>Nordrhein-Westfalen</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="min_leistung" class="form-label">Min. Leistung (kW)</label>
                                <input type="number" name="min_leistung" id="min_leistung" class="form-control" 
                                       value="{{ request.GET.min_leistung|default:'' }}" placeholder="0">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="max_leistung" class="form-label">Max. Leistung (kW)</label>
                                <input type="number" name="max_leistung" id="max_leistung" class="form-control" 
                                       value="{{ request.GET.max_leistung|default:'' }}" placeholder="1000000">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="status" class="form-label">Status</label>
                                <select name="status" id="status" class="form-select">
                                    <option value="">Alle Status</option>
                                    {% for status in status_list %}
                                        <option value="{{ status }}" {% if request.GET.status == status %}selected{% endif %}>{{ status }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="plz" class="form-label">PLZ</label>
                                <input type="text" name="plz" id="plz" class="form-control" 
                                       value="{{ request.GET.plz|default:'' }}" placeholder="12345">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="ort" class="form-label">Ort</label>
                                <input type="text" name="ort" id="ort" class="form-control" 
                                       value="{{ request.GET.ort|default:'' }}" placeholder="Stadtname">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="technologie" class="form-label">Technologie</label>
                                <select name="technologie" id="technologie" class="form-select">
                                    <option value="">Alle Technologien</option>
                                    {% for tech in technologie_list %}
                                        <option value="{{ tech }}" {% if request.GET.technologie == tech %}selected{% endif %}>{{ tech }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="art_solar" class="form-label">Solaranlagen-Art</label>
                                <select name="art_solar" id="art_solar" class="form-select">
                                    <option value="">Alle Solararten</option>
                                    {% for art in art_solar_list %}
                                        <option value="{{ art }}" {% if request.GET.art_solar == art %}selected{% endif %}>{{ art }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="betreiber" class="form-label">Betreiber</label>
                                <input type="text" name="betreiber" id="betreiber" class="form-control" 
                                       value="{{ request.GET.betreiber|default:'' }}" placeholder="Betreibername">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="datum_von" class="form-label">Inbetriebnahme von</label>
                                <input type="date" name="datum_von" id="datum_von" class="form-control" 
                                       value="{{ request.GET.datum_von|default:'' }}">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="datum_bis" class="form-label">Inbetriebnahme bis</label>
                                <input type="date" name="datum_bis" id="datum_bis" class="form-control" 
                                       value="{{ request.GET.datum_bis|default:'' }}">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="radius_plz" class="form-label">Umkreissuche PLZ</label>
                                <input type="text" name="radius_plz" id="radius_plz" class="form-control" 
                                       value="{{ request.GET.radius_plz|default:'' }}" placeholder="Zentrum PLZ">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="radius_km" class="form-label">Radius (km)</label>
                                <input type="number" name="radius_km" id="radius_km" class="form-control" 
                                       value="{{ request.GET.radius_km|default:'' }}" placeholder="50" min="1" max="500">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="freitext" class="form-label">Freitextsuche</label>
                                <input type="text" name="freitext" id="freitext" class="form-control" 
                                       value="{{ request.GET.freitext|default:'' }}" placeholder="Beliebiger Suchbegriff">
                            </div>
                            <div class="col-md-3 mb-3 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-search"></i> Suchen
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Gespeicherte Listen -->
    {% if user.is_authenticated %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="anlagen-listen-panel">
                <h6><i class="fas fa-list"></i> Gespeicherte Listen</h6>
                <div class="row">
                    {% for liste in gespeicherte_listen %}
                    <div class="col-md-4 mb-2">
                        <div class="liste-item" onclick="loadListe({{ liste.id }})">
                            <strong>{{ liste.name }}</strong><br>
                            <small>{{ liste.anlagen.count }} Anlagen</small>
                        </div>
                    </div>
                    {% empty %}
                    <div class="col-12">
                        <p class="text-muted mb-0">Noch keine Listen gespeichert.</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Suchergebnisse -->
    {% if rows %}
    <div class="row">
        <div class="col-12">
            <!-- Tabellenansicht -->
            <div class="table-view active" id="table-view">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-table text-primary"></i>
                            Suchergebnisse
                            {% if page_obj %}
                                <span class="badge bg-secondary ms-2">{{ page_obj.paginator.count }} Ergebnisse</span>
                            {% endif %}
                        </h5>
                        <div class="d-flex align-items-center">
                            <div class="input-group me-3" style="width: 300px;">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" class="form-control" id="tableSearch" placeholder="In Tabelle suchen...">
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="selectAll()">
                                <i class="fas fa-check-square"></i> Alle auswählen
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deselectAll()">
                                <i class="fas fa-square"></i> Alle abwählen
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Verbesserte Legende für Suchergebnisse -->
                        <div class="alert alert-info mb-3">
                            <h6><i class="fas fa-info-circle"></i> Spaltenübersicht - Was bedeuten die Daten?</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <h6 class="text-primary"><i class="fas fa-industry"></i> Anlagen-Informationen</h6>
                                    <ul class="mb-0 small">
                                        <li><strong>Anlagenname:</strong> Offizieller Name der Anlage im MaStR</li>
                                        <li><strong>Energieträger:</strong> Art der Energieerzeugung (Solar, Wind, etc.)</li>
                                        <li><strong>Leistung (kW):</strong> Elektrische Bruttoleistung in Kilowatt</li>
                                        <li><strong>Technologie:</strong> Spezifische Technologie der Anlage</li>
                                        <li><strong>Status:</strong> Aktueller Betriebsstatus (In Betrieb, Stillgelegt, etc.)</li>
                                    </ul>
                                </div>
                                <div class="col-md-4">
                                    <h6 class="text-success"><i class="fas fa-map-marker-alt"></i> Standort-Informationen</h6>
                                    <ul class="mb-0 small">
                                        <li><strong>Bundesland:</strong> Bundesland des Anlagenstandorts</li>
                                        <li><strong>Ort:</strong> Stadt oder Gemeinde der Anlage</li>
                                        <li><strong>PLZ:</strong> Postleitzahl des Standorts</li>
                                        <li><strong>Inbetriebnahme:</strong> Datum der ersten Inbetriebnahme</li>
                                    </ul>
                                </div>
                                <div class="col-md-4">
                                    <h6 class="text-warning"><i class="fas fa-building"></i> Betreiber-Informationen</h6>
                                    <ul class="mb-0 small">
                                        <li><strong>Betreiber:</strong> Name des Anlagenbetreibers</li>
                                        <li><strong>Betreibernummer:</strong> Eindeutige MaStR-Nummer des Betreibers</li>
                                        <li><strong>Anlagenart:</strong> Spezifische Art der Solaranlage (falls zutreffend)</li>
                                    </ul>
                                </div>
                            </div>
                            <hr>
                            <div class="row">
                                <div class="col-12">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-lightbulb text-warning me-2"></i>
                                        <small class="text-muted">
                                            <strong>Tipp:</strong> Klicken Sie auf die Spaltenüberschriften zum Sortieren. 
                                            Nutzen Sie die Checkboxen um Anlagen für Listen auszuwählen.
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-light align-middle">
                                    <tr>
                                        <th width="50" class="text-center">
                                            <input type="checkbox" id="selectAllCheckbox" onchange="toggleAllCheckboxes()" title="Alle auswählen">
                                        </th>
                                        {% for column in columns %}
                                            {% if column == 'Anlagenname' %}
                                                <th class="text-nowrap sortable" title="Name der Anlage aus dem MaStR" onclick="sortTable({{ forloop.counter0 }})">
                                                    <i class="fas fa-industry text-info me-1"></i>Anlagenname 
                                                    <i class="fas fa-info-circle text-secondary ms-1" title="Name der Anlage aus dem MaStR"></i>
                                                </th>
                                            {% elif column == 'Energieträger' %}
                                                <th class="text-nowrap sortable" title="Energieträger (z.B. Solar, Wind, etc.)" onclick="sortTable({{ forloop.counter0 }})">
                                                    <i class="fas fa-bolt text-warning me-1"></i>Energieträger 
                                                    <i class="fas fa-info-circle text-secondary ms-1" title="Energieträger (z.B. Solar, Wind, etc.)"></i>
                                                </th>
                                            {% elif column == 'Leistung (kW)' %}
                                                <th class="text-nowrap sortable" title="Bruttoleistung der Einheit in kW" onclick="sortTable({{ forloop.counter0 }})">
                                                    <i class="fas fa-tachometer-alt text-success me-1"></i>Leistung (kW) 
                                                    <i class="fas fa-info-circle text-secondary ms-1" title="Bruttoleistung der Einheit in kW"></i>
                                                </th>
                                            {% elif column == 'Bundesland' %}
                                                <th class="text-nowrap sortable" title="Bundesland des Standorts" onclick="sortTable({{ forloop.counter0 }})">
                                                    <i class="fas fa-map-marker-alt text-danger me-1"></i>Bundesland 
                                                    <i class="fas fa-info-circle text-secondary ms-1" title="Bundesland des Standorts"></i>
                                                </th>
                                            {% elif column == 'Ort' %}
                                                <th class="text-nowrap sortable" title="Ort des Standorts" onclick="sortTable({{ forloop.counter0 }})">
                                                    <i class="fas fa-city text-primary me-1"></i>Ort 
                                                    <i class="fas fa-info-circle text-secondary ms-1" title="Ort des Standorts"></i>
                                                </th>
                                            {% elif column == 'PLZ' %}
                                                <th class="text-nowrap sortable" title="Postleitzahl des Standorts" onclick="sortTable({{ forloop.counter0 }})">
                                                    <i class="fas fa-mail-bulk text-info me-1"></i>PLZ 
                                                    <i class="fas fa-info-circle text-secondary ms-1" title="Postleitzahl des Standorts"></i>
                                                </th>
                                            {% elif column == 'Status' %}
                                                <th class="text-nowrap sortable" title="Betriebsstatus der Anlage" onclick="sortTable({{ forloop.counter0 }})">
                                                    <i class="fas fa-toggle-on text-success me-1"></i>Status 
                                                    <i class="fas fa-info-circle text-secondary ms-1" title="Betriebsstatus der Anlage"></i>
                                                </th>
                                            {% elif column == 'Technologie' %}
                                                <th class="text-nowrap sortable" title="Spezifische Technologie" onclick="sortTable({{ forloop.counter0 }})">
                                                    <i class="fas fa-cogs text-warning me-1"></i>Technologie 
                                                    <i class="fas fa-info-circle text-secondary ms-1" title="Spezifische Technologie"></i>
                                                </th>
                                            {% elif column == 'Betreiber' %}
                                                <th class="text-nowrap sortable" title="Name des Anlagenbetreibers" onclick="sortTable({{ forloop.counter0 }})">
                                                    <i class="fas fa-building text-primary me-1"></i>Betreiber 
                                                    <i class="fas fa-info-circle text-secondary ms-1" title="Name des Anlagenbetreibers"></i>
                                                </th>
                                            {% elif column == 'Betreibernummer' %}
                                                <th class="text-nowrap sortable" title="Eindeutige MaStR-Nummer des Betreibers" onclick="sortTable({{ forloop.counter0 }})">
                                                    <i class="fas fa-id-card text-info me-1"></i>Betreibernummer 
                                                    <i class="fas fa-info-circle text-secondary ms-1" title="Eindeutige MaStR-Nummer des Betreibers"></i>
                                                </th>
                                            {% elif column == 'Inbetriebnahme' %}
                                                <th class="text-nowrap sortable" title="Datum der Inbetriebnahme" onclick="sortTable({{ forloop.counter0 }})">
                                                    <i class="fas fa-calendar-alt text-success me-1"></i>Inbetriebnahme 
                                                    <i class="fas fa-info-circle text-secondary ms-1" title="Datum der Inbetriebnahme"></i>
                                                </th>
                                            {% elif column == 'Art der Solaranlage' %}
                                                <th class="text-nowrap sortable" title="Spezifische Art der Solaranlage" onclick="sortTable({{ forloop.counter0 }})">
                                                    <i class="fas fa-solar-panel text-warning me-1"></i>Solar-Art 
                                                    <i class="fas fa-info-circle text-secondary ms-1" title="Spezifische Art der Solaranlage"></i>
                                                </th>
                                            {% else %}
                                                <th class="text-nowrap sortable" onclick="sortTable({{ forloop.counter0 }})" title="{{ column }}">
                                                    {{ column }}
                                                    <i class="fas fa-info-circle text-secondary ms-1" title="{{ column }}"></i>
                                                </th>
                                            {% endif %}
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in rows %}
                                        <tr>
                                            <td>
                                                <input type="checkbox" class="anlage-checkbox" value="{{ forloop.counter0 }}" data-row="{{ forloop.counter0 }}">
                                            </td>
                                            {% for value in row %}
                                                <td>{{ value|default:"-" }}</td>
                                            {% endfor %}
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Pagination -->
                        {% if page_obj.has_other_pages %}
                            <nav aria-label="Suchergebnisse Navigation">
                                <ul class="pagination justify-content-center">
                                    {% if page_obj.has_previous %}
                                        <li class="page-item">
                                            <a class="page-link" href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page={{ page_obj.previous_page_number }}">
                                                <i class="fas fa-chevron-left"></i> Zurück
                                            </a>
                                        </li>
                                    {% endif %}
                                    
                                    {% for num in page_obj.paginator.page_range %}
                                        {% if page_obj.number == num %}
                                            <li class="page-item active">
                                                <span class="page-link">{{ num }}</span>
                                            </li>
                                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                            <li class="page-item">
                                                <a class="page-link" href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page={{ num }}">{{ num }}</a>
                                            </li>
                                        {% endif %}
                                    {% endfor %}
                                    
                                    {% if page_obj.has_next %}
                                        <li class="page-item">
                                            <a class="page-link" href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page={{ page_obj.next_page_number }}">
                                                Weiter <i class="fas fa-chevron-right"></i>
                                            </a>
                                        </li>
                                    {% endif %}
                                </ul>
                            </nav>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Kartenansicht -->
            <div class="card-view" id="card-view">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-map text-primary"></i>
                            Kartenansicht
                            {% if page_obj %}
                                <span class="badge bg-secondary ms-2">{{ page_obj.paginator.count }} Ergebnisse</span>
                            {% endif %}
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="anlagen-map" style="height: 600px; width: 100%;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
        </div>
    </div>
    {% elif error %}
    <div class="row">
        <div class="col-12">
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i>
                {{ error }}
            </div>
        </div>
    </div>
    {% else %}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Keine Suchergebnisse</h5>
                    <p class="text-muted">Geben Sie Suchkriterien ein und klicken Sie auf "Suchen", um Anlagen zu finden.</p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Anlagen-Details Modal -->
<div class="modal fade" id="anlageDetailsModal" tabindex="-1" aria-labelledby="anlageDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="anlageDetailsModalLabel">
                    <i class="fas fa-industry"></i> Anlagen-Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="anlageDetailsContent">
                <!-- Details werden hier dynamisch eingefügt -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
                <button type="button" class="btn btn-primary" id="saveAnlageFromModal">
                    <i class="fas fa-save"></i> Anlage speichern
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- Leaflet JavaScript -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

<script>
// View Toggle
document.getElementById('btn-table-view').addEventListener('click', function() {
    document.getElementById('table-view').classList.add('active');
    document.getElementById('card-view').classList.remove('active');
    this.classList.add('btn-primary');
    this.classList.remove('btn-outline-primary');
    document.getElementById('btn-card-view').classList.add('btn-outline-primary');
    document.getElementById('btn-card-view').classList.remove('btn-primary');
});

document.getElementById('btn-card-view').addEventListener('click', function() {
    document.getElementById('card-view').classList.add('active');
    document.getElementById('table-view').classList.remove('active');
    this.classList.add('btn-primary');
    this.classList.remove('btn-outline-primary');
    document.getElementById('btn-table-view').classList.add('btn-outline-primary');
    document.getElementById('btn-table-view').classList.remove('btn-primary');
});

// Anlagen-Details anzeigen
function showAnlageDetails(rowIndex) {
    const rows = {{ rows|safe }};
    const columns = {{ columns|safe }};
    const row = rows[rowIndex];
    
    let detailsHtml = '<div class="row">';
    for (let i = 0; i < columns.length; i++) {
        detailsHtml += `
            <div class="col-md-6 mb-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title text-primary">${columns[i]}</h6>
                        <p class="card-text">${row[i] || '-'}</p>
                    </div>
                </div>
            </div>
        `;
    }
    detailsHtml += '</div>';
    
    document.getElementById('anlageDetailsContent').innerHTML = detailsHtml;
    document.getElementById('saveAnlageFromModal').onclick = function() {
        saveAnlage(rowIndex);
    };
    
    const modal = new bootstrap.Modal(document.getElementById('anlageDetailsModal'));
    modal.show();
}

// Anlage speichern
function saveAnlage(rowIndex) {
    if (!{{ user.is_authenticated|yesno:"true,false" }}) {
        alert('Bitte melden Sie sich an, um Anlagen zu speichern.');
        return;
    }
    
    const rows = {{ rows|safe }};
    const columns = {{ columns|safe }};
    const row = rows[rowIndex];
    
    // Hier würde die AJAX-Anfrage zum Speichern der Anlage erfolgen
    fetch('{% url "dashboard:anlage_speichern" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            row_index: rowIndex,
            data: row,
            columns: columns
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Anlage erfolgreich gespeichert!');
            // Button deaktivieren
            const buttons = document.querySelectorAll(`[onclick="saveAnlage(${rowIndex})"]`);
            buttons.forEach(btn => {
                btn.disabled = true;
                btn.textContent = 'Gespeichert';
                btn.classList.remove('btn-save-anlage');
                btn.classList.add('btn-secondary');
            });
        } else {
            alert('Fehler beim Speichern der Anlage: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Fehler beim Speichern der Anlage.');
    });
}

// Bestehende Funktionen...
function selectAll() {
    const checkboxes = document.querySelectorAll('.anlage-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = true;
    });
    document.getElementById('selectAllCheckbox').checked = true;
}

function deselectAll() {
    const checkboxes = document.querySelectorAll('.anlage-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    document.getElementById('selectAllCheckbox').checked = false;
}

function toggleAllCheckboxes() {
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const checkboxes = document.querySelectorAll('.anlage-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });
}

// Tabellensuche
document.getElementById('tableSearch').addEventListener('keyup', function() {
    const searchTerm = this.value.toLowerCase();
    const table = document.querySelector('.table tbody');
    const rows = table.querySelectorAll('tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
});

// Sortierung
function sortTable(columnIndex) {
    const table = document.querySelector('.table');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    const header = table.querySelector(`th:nth-child(${columnIndex + 2})`); // +2 wegen Checkbox-Spalte
    
    // Sortierrichtung umschalten
    const isAscending = !header.classList.contains('sort-asc');
    
    // Alle Sortier-Klassen entfernen
    table.querySelectorAll('th').forEach(th => {
        th.classList.remove('sort-asc', 'sort-desc');
    });
    
    // Neue Sortier-Klasse hinzufügen
    header.classList.add(isAscending ? 'sort-asc' : 'sort-desc');
    
    // Zeilen sortieren
    rows.sort((a, b) => {
        const aValue = a.cells[columnIndex + 1].textContent.trim(); // +1 wegen Checkbox-Spalte
        const bValue = b.cells[columnIndex + 1].textContent.trim();
        
        // Numerische Sortierung für Leistung
        if (columns[columnIndex] === 'Leistung (kW)') {
            const aNum = parseFloat(aValue) || 0;
            const bNum = parseFloat(bValue) || 0;
            return isAscending ? aNum - bNum : bNum - aNum;
        }
        
        // String-Sortierung
        if (isAscending) {
            return aValue.localeCompare(bValue, 'de');
        } else {
            return bValue.localeCompare(aValue, 'de');
        }
    });
    
    // Sortierte Zeilen wieder einfügen
    rows.forEach(row => tbody.appendChild(row));
}

// Listen laden
function loadListe(listeId) {
    // Hier würde die AJAX-Anfrage zum Laden der Liste erfolgen
    console.log('Lade Liste:', listeId);
}

// Leaflet Kartenfunktionalität
let map = null;
let markerClusterGroup = null;

// Karte initialisieren
function initMap() {
    if (map) {
        map.remove();
    }
    
    // Deutschland-Zentrum
    const germanyCenter = [51.1657, 10.4515];
    
    map = L.map('anlagen-map').setView(germanyCenter, 6);
    
    // OpenStreetMap Tile Layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);
    
    // Marker Cluster Group
    markerClusterGroup = L.markerClusterGroup({
        chunkedLoading: true,
        maxClusterRadius: 50,
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        zoomToBoundsOnClick: true
    });
    
    map.addLayer(markerClusterGroup);
    
    // Anlagen-Marker hinzufügen
    addAnlagenMarkers();
}

// Anlagen-Marker zur Karte hinzufügen
function addAnlagenMarkers() {
    const anlagenListe = JSON.parse('{{ anlagen_liste|escapejs }}');
    
    console.log('Anlagen für Karte:', anlagenListe);
    console.log('Anzahl Anlagen:', anlagenListe.length);
    
    anlagenListe.forEach((anlage, index) => {
        if (anlage.lat && anlage.lon && !isNaN(anlage.lat) && !isNaN(anlage.lon)) {
            // Marker-Icon basierend auf Energieträger und Koordinaten-Genauigkeit
            const energietraeger = anlage.energietraeger || 'Unbekannt';
            const hasPreciseCoords = anlage.has_precise_coords || false;
            const icon = getMarkerIcon(energietraeger, hasPreciseCoords);
            
            // Popup-Inhalt erstellen
            const popupContent = createAnlagePopupContent(anlage, index);
            
            // Marker erstellen und hinzufügen
            const marker = L.marker([anlage.lat, anlage.lon], { icon: icon })
                .bindPopup(popupContent, { maxWidth: 300 })
                .on('click', function() {
                    // Marker-Klick-Handler
                    console.log('Anlage geklickt:', index);
                });
            
            markerClusterGroup.addLayer(marker);
        }
    });
}

// Marker-Icon basierend auf Energieträger und Koordinaten-Genauigkeit
function getMarkerIcon(energietraeger, hasPreciseCoords = false) {
    const iconSize = [25, 25];
    const iconAnchor = [12, 12];
    
    let iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png';
    
    // Wenn keine präzisen Koordinaten, verwende gestreifte Marker
    if (!hasPreciseCoords) {
        switch(energietraeger.toLowerCase()) {
            case 'solar':
                iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png';
                break;
            case 'wind':
                iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-lightgreen.png';
                break;
            case 'biomasse':
                iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-pink.png';
                break;
            case 'wasser':
                iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-lightblue.png';
                break;
            default:
                iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-lightgrey.png';
        }
    } else {
        // Präzise Koordinaten - verwende normale Marker
        switch(energietraeger.toLowerCase()) {
            case 'solar':
                iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-yellow.png';
                break;
            case 'wind':
                iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png';
                break;
            case 'biomasse':
                iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png';
                break;
            case 'wasser':
                iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png';
                break;
            default:
                iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-grey.png';
        }
    }
    
    return L.icon({
        iconUrl: iconUrl,
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: iconSize,
        iconAnchor: iconAnchor,
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });
}

// Popup-Inhalt für Anlagen erstellen
function createAnlagePopupContent(anlage, index) {
    let content = '<div class="anlage-popup">';
    content += `<h6><i class="fas fa-industry"></i> ${anlage.name || 'Unbekannte Anlage'}</h6>`;
    
    // Koordinaten-Genauigkeit anzeigen
    if (anlage.has_precise_coords) {
        content += '<span class="badge bg-success mb-2"><i class="fas fa-crosshairs"></i> Präzise Koordinaten</span>';
    } else {
        content += '<span class="badge bg-warning mb-2"><i class="fas fa-map-marker-alt"></i> PLZ-Koordinaten</span>';
    }
    
    content += '<div class="popup-details">';
    
    // Wichtige Informationen anzeigen
    if (anlage.energietraeger) {
        content += `<p><i class="fas fa-bolt"></i> <strong>Energieträger:</strong> ${anlage.energietraeger}</p>`;
    }
    if (anlage.leistung) {
        content += `<p><i class="fas fa-tachometer-alt"></i> <strong>Leistung:</strong> ${anlage.leistung} kW</p>`;
    }
    if (anlage.ort) {
        content += `<p><i class="fas fa-city"></i> <strong>Ort:</strong> ${anlage.ort}</p>`;
    }
    if (anlage.plz) {
        content += `<p><i class="fas fa-mail-bulk"></i> <strong>PLZ:</strong> ${anlage.plz}</p>`;
    }
    if (anlage.strasse && anlage.hausnummer) {
        content += `<p><i class="fas fa-map-pin"></i> <strong>Adresse:</strong> ${anlage.strasse} ${anlage.hausnummer}</p>`;
    } else if (anlage.strasse) {
        content += `<p><i class="fas fa-map-pin"></i> <strong>Straße:</strong> ${anlage.strasse}</p>`;
    }
    
    content += '</div>';
    content += '<div class="popup-actions mt-2">';
    content += `<button class="btn btn-sm btn-primary me-1" onclick="showAnlageDetails(${index})">`;
    content += '<i class="fas fa-eye"></i> Details</button>';
    content += `<button class="btn btn-sm btn-success" onclick="saveAnlage(${index})">`;
    content += '<i class="fas fa-save"></i> Speichern</button>';
    content += '</div>';
    content += '</div>';
    
    return content;
}

// Karte initialisieren wenn Kartenansicht aktiviert wird
document.getElementById('btn-card-view').addEventListener('click', function() {
    // Kurze Verzögerung um sicherzustellen, dass das Element sichtbar ist
    setTimeout(() => {
        if (!map) {
            initMap();
        }
    }, 100);
});

// Karte bei Seitenladung initialisieren, falls Kartenansicht aktiv ist
document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('card-view').classList.contains('active')) {
        initMap();
    }
    
    // Button-Umschaltung für Tabellen/Karten-Ansicht
    const btnTableView = document.getElementById('btn-table-view');
    const btnCardView = document.getElementById('btn-card-view');
    const tableView = document.getElementById('table-view');
    const cardView = document.getElementById('card-view');
    
    btnTableView.addEventListener('click', function() {
        // Buttons aktualisieren
        btnTableView.classList.remove('btn-outline-primary');
        btnTableView.classList.add('btn-primary', 'active');
        btnCardView.classList.remove('btn-primary', 'active');
        btnCardView.classList.add('btn-outline-primary');
        
        // Ansichten umschalten
        tableView.classList.add('active');
        cardView.classList.remove('active');
        
        // Paginierung in Tabellenansicht anzeigen
        const pagination = document.querySelector('.pagination');
        if (pagination) {
            pagination.style.display = 'flex';
        }
    });
    
    btnCardView.addEventListener('click', function() {
        // Buttons aktualisieren
        btnCardView.classList.remove('btn-outline-primary');
        btnCardView.classList.add('btn-primary', 'active');
        btnTableView.classList.remove('btn-primary', 'active');
        btnTableView.classList.add('btn-outline-primary');
        
        // Ansichten umschalten
        cardView.classList.add('active');
        tableView.classList.remove('active');
        
        // Paginierung in Kartenansicht ausblenden
        const pagination = document.querySelector('.pagination');
        if (pagination) {
            pagination.style.display = 'none';
        }
        
        // Karte initialisieren falls noch nicht geschehen
        setTimeout(() => {
            if (!map) {
                initMap();
            }
        }, 100);
    });
});
</script>
{% endblock %} 